name: Spear Core Save Test Results
description: A GitHub action to store test results in S3
branding:
  icon: check-circle
  color: green
inputs:
  s3Bucket:
    description: The S3 Bucket
    required: true
  projectKey:
    description: The project identifier or key
    required: true
  releaseTag:
    description: The release tag or branch
    required: true
  sourceDir:
    description: Target Directory
    required: true
  

runs:
  using: 'composite'
  steps:

    - name: Add git-status.txt
      shell: bash
      run: git log -1 > "${{ inputs.sourceDir }}/git-status.txt"

    - name: Add s3-path.txt
      shell: bash
      run: echo "$s3Target" > "${{ inputs.sourceDir }}/s3-path.txt"

    - name: Save Test Results
      shell: bash
      run: aws s3 sync --only-show-errors --delete "./${{ inputs.sourceDir }}" "s3://${{ inputs.s3Bucket }}/${{ inputs.projectKey }}/${{ inputs.releaseTag }}"

    - name: Save Latest Results
      shell: bash
      if: startswith(inputs.releaseTag, 'releases/')
      run: aws s3 sync --only-show-errors --delete "./${{ inputs.sourceDir }}" "s3://${{ inputs.s3Bucket }}/${{ inputs.projectKey }}/releases/$(echo "${{ inputs.releaseTag }}" | cut -d/ -f2)/latest"


